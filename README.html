<!DOCTYPE html>
<html>
  <body>
    <h1>Aurite Service Architecture</h1>

    <h2>Overview</h2>
    <p>
      The Aurite service architecture implements a modular, event-driven system
      using Redis streams for communication between services. The core
      components are built on a service registry pattern with dependency
      injection.
    </p>

    <h2>Core Components</h2>

    <h3>1. Service Registry</h3>
    <pre>
# Service registry pattern (__init__.py)
registry = {
    "config_service": config_service,
    "embeddings_service": embeddings_service,
    "llm_service": llm_service,
    "rag_service": rag_service,
    "communication_service": communication_service,
    "stream_service": stream_service,
    "txtai_service": txtai_service,
}
</pre
    >

    <h3>2. Base Service Pattern</h3>
    <pre>
# All services inherit from BaseService
class BaseService:
    def __init__(self):
        self._initialized = False
        self.settings = None
        self.config_service = config_service
</pre
    >

    <h3>3. Configuration Management</h3>
    <pre>
# Settings managed by Pydantic
class Settings(BaseSettings):
    # Redis Configuration
    REDIS_HOST: str
    REDIS_PORT: int
    REDIS_DB: int

    # Stream Configuration
    STREAMS: List[str]
    CONSUMER_GROUP: str
    CONSUMER_NAME: str
</pre
    >

    <h2>Service Communication</h2>

    <h3>Redis Streams</h3>
    <ul>
      <li>rag_stream: RAG operations</li>
      <li>embeddings_stream: Embedding operations</li>
      <li>llm_stream: LLM operations</li>
    </ul>

    <h3>Message Format</h3>
    <pre>
{
    "type": MessageType,  # e.g., "rag_request"
    "data": Dict[str, Any],  # Operation-specific data
    "session_id": str  # Session tracking
}
</pre
    >

    <h2>Testing Infrastructure</h2>

    <h3>Test Configuration (conftest.py)</h3>
    <pre>
@pytest.fixture(scope="session")
async def initialized_services(event_loop, test_settings, redis_client):
    # Initialize services in order
    registry.config_service.settings = test_settings
    await registry.config_service.initialize()
    # ... initialize other services
</pre
    >

    <h3>Redis Test Setup</h3>
    <ul>
      <li>Uses separate test database (DB 1)</li>
      <li>Automatic cleanup between tests</li>
      <li>Session-scoped event loop</li>
      <li>Shared Redis client</li>
    </ul>

    <h2>Implementation Notes</h2>

    <h3>Service Initialization Flow</h3>
    <ol>
      <li>Config service initializes first</li>
      <li>Services get settings through base_service</li>
      <li>Redis connections established</li>
      <li>Stream consumers created</li>
    </ol>

    <h3>Requirements</h3>
    <ul>
      <li>Redis >= 5.0</li>
      <li>Python 3.11+</li>
      <li>redis-py >= 4.2.0</li>
      <li>pytest-asyncio</li>
    </ul>

    <h2>Development Commands</h2>
    <pre>
# Run tests
just test

# Test Redis specifically
just test-redis

# Start API
just serve

# Development mode
just dev
</pre
    >

    <h2>Environment Setup</h2>
    <pre>
# Install dependencies
just setup
just install

# Update environment
just update
</pre
    >
  </body>
</html>
